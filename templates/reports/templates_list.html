{% extends "base.html" %}
{% block title %}Explore Insight Templates{% endblock %}

{% block content %}
<div class="container">
  <h2 class="mb-3">
    Explore Insight Templates
    (<span id="templates-count">{{ templates|length }}</span>)
  </h2>
  <p>
    Insight templates are the blueprints for generating insights from your data. The list below can be filtered by period or by a search term in the title or description. Select a template to view its details, and use the link below the description to access all insights that have been generated with that template.
  </p>

  <!-- Filter Form (GET) -->
  <form id="filter-form" method="get" class="row g-3 mb-4" autocomplete="off">
    <div class="col-md-3">
      <label for="period" class="form-label">Period</label>
      <select id="period" name="period" class="form-select">
        <option value="">All periods</option>
        {% for p in periods %}
          <option value="{{ p.id }}" {% if request.GET.period == p.id|stringformat:"s" %}selected{% endif %}>
            {{ p.value }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-9">
      <label for="search" class="form-label">Title contains...</label>
      <input id="search" name="search" class="form-control"
             placeholder="Type to filter templates..."
             value="{{ request.GET.search|default:'' }}">
    </div>

    <div class="col-12 d-flex justify-content-end">
      <button type="submit" class="btn btn-primary visually-hidden">Apply</button>
    </div>
  </form>

  <!-- Ergebnisliste (nur eine Select-Liste) -->
  <div class="row mb-3">
    <div class="col-12">
      <label for="template-select" class="form-label">
        Choose an insight template
        <small class="text-muted">
          (<span id="template-select-count">{{ templates|length }}</span> found)
        </small>
      </label>
      <select id="template-select" class="form-select">
        {% for t in templates %}
          <option value="{{ t.id }}"
                  data-period="{{ t.reference_period.id|default:'' }}"
                  {% if selected_template and t.id == selected_template.id %}selected{% endif %}>
            {{ t.title }} ({{ t.reference_period }})
          </option>
        {% empty %}
          <option disabled>No templates available</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <br>
  <!-- Detailbereich -->
  <div id="template-details" class="mt-4">
    {% if selected_template %}
      <h3 id="details-title">{{ selected_template.title }} ({{ selected_template.reference_period }})</h3>
      <hr>
      <div id="details-body">{{ selected_template.description_html|safe }}</div>
      <hr>
      <p class="text-muted mb-2">
        {{ subscribed_count|default:"0" }} of {{ total_users|default:"0" }} users have subscribed to this template
      </p>
      <a id="details-link" href="{% url 'stories' %}?template={{ selected_template.id }}">
        View all {{ story_count }} insights created with this template
      </a>
    {% else %}
      <div class="card p-3 text-muted">
        Select a template from the dropdown above to view details here.
      </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('filter-form');
  const periodSelect = document.getElementById('period');
  const searchInput = document.getElementById('search');
  const listSelect = document.getElementById('template-select');

  // Debounce
  function debounce(fn, wait) {
    let t = null;
    return function (...args) {
      if (t) clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  // FilterÃ¤nderungen -> Server neu laden
  if (periodSelect) {
    periodSelect.addEventListener('change', function () {
      form.requestSubmit();
    });
  }
  if (searchInput) {
    const debounced = debounce(() => form.requestSubmit(), 300);
    searchInput.addEventListener('input', debounced);
    searchInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') { e.preventDefault(); form.requestSubmit(); }
    });
  }

  // Auswahl eines Templates -> mit aktuellen Filtern + ?template= navigieren
  if (listSelect) {
    listSelect.addEventListener('change', function () {
      const id = this.value || '';
      const params = new URLSearchParams(new FormData(form));
      if (id) params.set('template', id); else params.delete('template');
      window.location.href = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
    });
  }
});
</script>
{% endblock %}
