{% extends "base.html" %}
{% load custom_filters %}
{% block title %}Explore Stories{% endblock %}
{% block content %}

<h2 class="mb-3">Explore Insights (<span id="stories-count">{{ stories|length }}</span>)</h2>
<!-- Filter Form -->
<form id="filter-form" method="get" class="row g-3 mb-4" autocomplete="off">
  <div class="col-md-3">
    <label for="reference_period" class="form-label">Reference period</label>
    <select class="form-select" id="reference_period" name="reference_period">
      <option value="">All periods</option>
      {% for period in periods %}
        <option value="{{ period }}" {% if request.GET.reference_period == period|stringformat:"s" %}selected{% endif %}>
          {{ period }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label for="template" class="form-label">Template</label>
    <select class="form-select" id="template" name="template">
      <option value="">All templates</option>
      {% for template in templates %}
        <option value="{{ template.id }}"
                data-reference-period="{{ template.reference_period }}"
                {% if request.GET.template == template.id|stringformat:"s" %}selected{% endif %}>
          {{ template.title }} ({{ template.reference_period }})
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4">
    <label for="search" class="form-label">Title contains...</label>
    <input type="text" class="form-control" id="search" name="search" value="{{ request.GET.search }}" placeholder="Title or description...">
  </div>

  <div class="col-md-2 d-flex align-items-end">
    <!-- Hidden submit kept for keyboard accessibility; JS will auto-submit -->
    <button type="submit" class="btn btn-primary w-100 visually-hidden">Filter</button>
  </div>
</form>


<div class="row">
  <div class="col-12">
    <div class="mb-3">
      <label for="story-select" class="form-label">
        Select insight
        <small class="text-muted">(<span id="story-select-count">{{ stories|length }}</span> found)</small>
      </label>
      <select id="story-select" class="form-select" data-selected="{{ selected_story.id|default:'' }}">
        {% for story in stories %}
          <option
            value="{{ story.id }}"
            data-template="{{ story.template.id|default:'' }}"
            data-period="{{ story.template.reference_period|default:'' }}"
            data-title="{{ story.title|escapejs }}"
            {% if selected_story and story.id == selected_story.id %}selected{% endif %}>
            {{ story.title }} — published on {{ story.published_date|date:"Y-m-d" }}
          </option>
        {% empty %}
          <option disabled>No stories found.</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <!-- Details appear below the dropdown -->
    {% if selected_story %}
      {% include "includes/story_detail_block.html" %}
    {% else %}
      <div class="card p-3 text-muted">
        Select an insight from the dropdown above to view details here.
      </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('filter-form');
  const templateSelect = document.getElementById('template');
  const periodSelect = document.getElementById('reference_period');
  const searchInput = document.getElementById('search');
  const storySelect = document.getElementById('story-select');

  // (optional) ursprüngliche Template-Options merken, um clientseitig nach Periode zu filtern
  let originalTemplateOptions = [];
  if (templateSelect) {
    originalTemplateOptions = Array.from(templateSelect.options).map(opt => ({
      value: opt.value,
      text: opt.text,
      period: opt.dataset ? opt.dataset.referencePeriod : opt.getAttribute('data-reference-period') || ''
    }));
  }

  function filterTemplateOptions(period) {
    if (!templateSelect) return;
    const prev = templateSelect.value;
    templateSelect.innerHTML = '';
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'All templates';
    templateSelect.appendChild(defaultOpt);

    originalTemplateOptions.forEach(o => {
      if (!o.value) return; // skip default "All templates" we already added
      if (!period || String(o.period) === String(period)) {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.text;
        opt.setAttribute('data-reference-period', o.period || '');
        templateSelect.appendChild(opt);
      }
    });

    // falls der bisherige Wert nicht mehr existiert, auf leer setzen
    const exists = Array.from(templateSelect.options).some(opt => opt.value === prev);
    templateSelect.value = exists ? prev : '';
  }

  // Debounce helper
  function debounce(fn, wait) {
    let t = null;
    return function (...args) {
      if (t) clearTimeout(t);
      t = setTimeout(() => { fn.apply(this, args); }, wait);
    };
  }

  // initial: Templates nach aktueller Periode einschränken (optional)
  if (periodSelect) filterTemplateOptions(periodSelect.value);

  // Änderungen -> Server submitten (Server filtert Stories + setzt selected_story)
  if (periodSelect) {
    periodSelect.addEventListener('change', function () {
      filterTemplateOptions(this.value); // optional UX
      form.requestSubmit();
    });
  }

  if (templateSelect) {
    templateSelect.addEventListener('change', function () {
      form.requestSubmit();
    });
  }

  if (searchInput) {
    const debouncedSubmit = debounce(() => form.requestSubmit(), 300);
    searchInput.addEventListener('input', debouncedSubmit);
    searchInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') { e.preventDefault(); form.requestSubmit(); }
    });
  }

  // Story-Auswahl -> Detailseite mit Query-Parametern laden
  if (storySelect) {
    storySelect.addEventListener('change', function () {
      const storyId = this.value || '';
      const params = new URLSearchParams(new FormData(form));
      if (storyId) params.set('story', storyId);
      const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.location.href = newUrl;
    });
  }
});
</script>

{% endblock %}