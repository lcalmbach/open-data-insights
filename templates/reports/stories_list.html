{% extends "base.html" %}
{% load custom_filters %}
{% block title %}Explore Stories{% endblock %}
{% block content %}

<h2 class="mb-3">Explore Insights (<span id="stories-count">{{ stories|length }}</span>)</h2>
<!-- Filter Form -->
<form id="filter-form" method="get" class="row g-3 mb-4" autocomplete="off">
  <div class="col-md-3">
    <label for="reference_period" class="form-label">Reference period</label>
    <select class="form-select" id="reference_period" name="reference_period">
      <option value="">All periods</option>
      {% for period in periods %}
        <option value="{{ period }}" {% if request.GET.reference_period == period|stringformat:"s" %}selected{% endif %}>
          {{ period }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3">
    <label for="template" class="form-label">Template</label>
    <select class="form-select" id="template" name="template">
      <option value="">All templates</option>
      {% for template in templates %}
        <option value="{{ template.id }}"
                data-reference-period="{{ template.reference_period }}"
                {% if request.GET.template == template.id|stringformat:"s" %}selected{% endif %}>
          {{ template.title }} ({{ template.reference_period }})
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4">
    <label for="search" class="form-label">Title contains...</label>
    <input type="text" class="form-control" id="search" name="search" value="{{ request.GET.search }}" placeholder="Title or description...">
  </div>

  <div class="col-md-2 d-flex align-items-end">
    <!-- Hidden submit kept for keyboard accessibility; JS will auto-submit -->
    <button type="submit" class="btn btn-primary w-100 visually-hidden">Filter</button>
  </div>
</form>


<div class="row">
  <div class="col-12">
    <div class="mb-3">
      <label for="story-select" class="form-label">
        Select insight
        <small class="text-muted">(<span id="story-select-count">{{ stories|length }}</span> found)</small>
      </label>
      <select id="story-select" class="form-select">
        {% for story in stories %}
          <option
            value="{{ story.id }}"
            data-template="{{ story.template.id|default:'' }}"
            data-period="{{ story.template.reference_period|default:'' }}"
            data-title="{{ story.title|escapejs }}"
            {% if selected_story and story.id == selected_story.id %}selected{% endif %}>
            {{ story.title }} â€” published on {{ story.published_date|date:"Y-m-d" }}
          </option>
        {% empty %}
          <option disabled>No stories found.</option>
        {% endfor %}
      </select>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-12">
    <!-- Details appear below the dropdown -->
    {% if selected_story %}
      {% include "includes/story_detail_block.html" %}
    {% else %}
      <div class="card p-3 text-muted">
        Select an insight from the dropdown above to view details here.
      </div>
    {% endif %}
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const templateSelect = document.getElementById('template');
  const periodSelect = document.getElementById('reference_period');
  const searchInput = document.getElementById('search');
  const storySelect = document.getElementById('story-select');
  const storiesCountEl = document.getElementById('stories-count');
  const storySelectCountEl = document.getElementById('story-select-count');

  // preserve original template options for client-side filtering
  let originalTemplateOptions = [];
  if (templateSelect) {
    originalTemplateOptions = Array.from(templateSelect.options).map(opt => ({
      value: opt.value,
      text: opt.text,
      period: opt.dataset ? opt.dataset.referencePeriod : opt.getAttribute('data-reference-period')
    }));
  }

  // preserve original story options for client-side filtering
  let originalStoryOptions = [];
  if (storySelect) {
    originalStoryOptions = Array.from(storySelect.options).map(opt => ({
      value: opt.value,
      text: opt.text,
      template: opt.getAttribute('data-template') || '',
      period: opt.getAttribute('data-period') || '',
      title: opt.getAttribute('data-title') || opt.textContent || ''
    }));
  }

  // helper to repopulate template select based on chosen period
  function filterTemplateOptions(period) {
    if (!templateSelect) return;
    const prev = templateSelect.value;
    templateSelect.innerHTML = '';
    const defaultOpt = document.createElement('option');
    defaultOpt.value = '';
    defaultOpt.textContent = 'All templates';
    templateSelect.appendChild(defaultOpt);

    originalTemplateOptions.forEach(o => {
      if (!period || String(o.period) === String(period)) {
        const opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.text;
        opt.setAttribute('data-reference-period', o.period || '');
        templateSelect.appendChild(opt);
      }
    });

    if (prev) {
      const exists = Array.from(templateSelect.options).some(opt => opt.value === prev);
      templateSelect.value = exists ? prev : '';
    }
  }

  // filter the story select options in-place by period/template/search
  function filterStoryOptions() {
    if (!storySelect) return;
    const selectedTemplate = templateSelect ? templateSelect.value.trim() : '';
    const selectedPeriod = periodSelect ? periodSelect.value.trim() : '';
    const q = searchInput ? searchInput.value.trim().toLowerCase() : '';

    // rebuild options
    storySelect.innerHTML = '';
    let matchCount = 0;
    originalStoryOptions.forEach(o => {
      // apply period filter
      if (selectedPeriod && String(o.period) !== String(selectedPeriod)) return;
      // apply template filter
      if (selectedTemplate && String(o.template) !== String(selectedTemplate)) return;
      // apply search filter (title)
      if (q && String(o.title).toLowerCase().indexOf(q) === -1) return;

      const opt = document.createElement('option');
      opt.value = o.value;
      opt.textContent = o.text;
      opt.setAttribute('data-template', o.template);
      opt.setAttribute('data-period', o.period);
      opt.setAttribute('data-title', o.title);
      storySelect.appendChild(opt);
      matchCount++;
    });

    if (matchCount === 0) {
      const emptyOpt = document.createElement('option');
      emptyOpt.disabled = true;
      emptyOpt.textContent = 'No stories found.';
      storySelect.appendChild(emptyOpt);
    }

    // update counts
    if (storiesCountEl) storiesCountEl.textContent = matchCount;
    if (storySelectCountEl) storySelectCountEl.textContent = matchCount;
  }

  // simple debounce
  function debounce(fn, wait) {
    let t = null;
    return function (...args) {
      if (t) clearTimeout(t);
      t = setTimeout(() => { fn.apply(this, args); }, wait);
    };
  }

  // initialize template list according to current period on page load
  if (periodSelect) filterTemplateOptions(periodSelect.value);

  // initialize story list filter on page load (in case template/period/search prefilled)
  filterStoryOptions();

  // when period changes: update template list and story list
  if (periodSelect) {
    periodSelect.addEventListener('change', function () {
      filterTemplateOptions(this.value);
      filterStoryOptions();
    });
  }

  // when template changes: update story list
  if (templateSelect) {
    templateSelect.addEventListener('change', function () {
      filterStoryOptions();
    });
  }

  // search input -> filter (debounced)
  if (searchInput) {
    const debounced = debounce(filterStoryOptions, 300);
    searchInput.addEventListener('input', debounced);
    searchInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') { e.preventDefault(); filterStoryOptions(); }
    });
  }

  // story select still navigates to story details (preserve filters as query params)
  if (storySelect) {
    storySelect.addEventListener('change', function () {
      const storyId = this.value || '';
      const params = new URLSearchParams();
      if (periodSelect && periodSelect.value) params.set('reference_period', periodSelect.value);
      if (templateSelect && templateSelect.value) params.set('template', templateSelect.value);
      if (searchInput && searchInput.value) params.set('search', searchInput.value);
      if (storyId) params.set('story', storyId);
      const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
      window.location.href = newUrl;
    });
  }
});
</script>
{% endblock %}