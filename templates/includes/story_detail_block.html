{% load custom_filters %}

<!-- templates/includes/story_detail_block.html -->
<div class="card mt-2 shadow-sm">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-start gap-3">
      <div>
        <h2 class="card-title mb-0 text-primary">{{ selected_story.title|safe }}</h2>
        <small class="d-block text-muted mt-1">
          Published: {{ selected_story.published_date|date:"F j, Y" }}
          &nbsp;&middot;&nbsp;
          Period: {{ selected_story.reference_period }}
        </small>
      </div>
      {% if user.is_staff %}
      <form
        class="mb-0"
        method="post"
        action="{% url 'delete_story' selected_story.id %}"
      >
        {% csrf_token %}
        <button
          type="submit"
          class="btn btn-outline-danger btn-sm"
          onclick="return confirm('Are you sure you want to delete this story?');"
        >
          Delete story
        </button>
      </form>
      {% endif %}
    </div>
  </div>
  <div class="card-body text-start">
    <b>
      <!-- debug: story id / template 
      storyid: {{selected_story.id}} template_id: {{selected_story.template.id}} ({{selected_story.template.title}})
      -->
      <p class="card-text mt-3">{{ selected_story.summary|safe }}</p>
    </b>
    <p class="card-text mt-3">{{ selected_story.content_html|safe }}</p>
  </div>

  {% if tables %}
  <div class="mb-3 p-3 bg-light rounded">
  {% for table in tables %}
  <hr>
  <h5>{{ table.display_title }}</h5>
  <table class="table table-striped" id="{{ table.table_id }}">
    <thead>
      <tr>
        {% for column in table.columns %}
        <th>{{ column }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in table.rows %}
      <tr>
        {% for col in table.columns %}
        <td>{{ row|get_item:col |safe}}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br>
  {% endfor %}
  </div>
  {% endif %}

  {% if graphics %}
    {% for graphic in graphics %}
    <h5>Figure {{ graphic.graphic_template.sort_order|default:0|add:"1" }}: {{ graphic.title }}</h5>
    {{ graphic.content_html|safe }}
    <!-- debug: graphic ids
cal    {{ graphic.id}} {{graphic.graphic_template.id}}
    -->
    {% endfor %}
  {% endif %}
  
  <div class="mb-3 p-3 bg-light rounded">
  {% if data_source %}
    Data source:
    {% for source in data_source %}
    <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">{{ source.text }}</a>{% if not forloop.last %},
    {% endif %}
    {% endfor %}
  {% endif %}

  {% if other_ressources %}
  <br>
    Additional resources:
    {% for source in other_ressources %}
    <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">{{ source.text }}</a>{% if not forloop.last %},
    {% endif %}
    {% endfor %}
  {% endif %}
  <br><br>
  <p style="font-size: 0.9em;">{{ AI_DISCLAIMER | safe }}</p>
  </div>
</div>
