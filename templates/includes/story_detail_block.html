{% load custom_filters %}

<!-- templates/includes/story_detail_block.html -->
<div class="card mt-2 shadow-sm">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-start gap-3">
      <div>
        <h2 class="card-title mb-0 text-primary">{{ selected_story.title|safe }}</h2>
        <small class="d-block text-muted mt-1">
          Published: {{ selected_story.published_date|date:"F j, Y" }}
          &nbsp;&middot;&nbsp;
          Period: {{ selected_story.reference_period }}
        </small>
        {% if user.is_authenticated and not user.is_staff %}
        <div class="mt-2">
          <a class="text-decoration-none" href="{% url 'rate_story' selected_story.id %}" title="Rate this story">
            {% if rating_count|default:0 %}
              <span class="me-2 fw-semibold text-dark">{{ rating_avg|floatformat:1 }}</span>
            {% else %}
              <span class="me-2 fw-semibold text-dark">0.0</span>
            {% endif %}
            {% for _ in "12345"|make_list %}
              {% if forloop.counter <= rating_stars_full|default:0 %}
                <i class="bi bi-star-fill text-warning"></i>
              {% elif rating_stars_half|default:0 and forloop.counter == rating_stars_full|default:0|add:"1" %}
                <i class="bi bi-star-half text-warning"></i>
              {% else %}
                <i class="bi bi-star text-warning"></i>
              {% endif %}
            {% endfor %}
            <span class="ms-2 text-muted">
              ({{ rating_count|default:0 }} rating{{ rating_count|default:0|pluralize }})
            </span>
          </a>
        </div>
        {% endif %}
      </div>
      {% if user.is_staff %}
      <form
        class="mb-0"
        method="post"
        action="{% url 'delete_story' selected_story.id %}"
      >
        {% csrf_token %}
        <button
          type="submit"
          class="btn btn-outline-danger btn-sm"
          onclick="return confirm('Are you sure you want to delete this story?');"
        >
          Delete story
        </button>
      </form>
      {% endif %}
    </div>
  </div>
  <div class="card-body text-start">
    <b>
      <!-- debug: story id / template 
      storyid: {{selected_story.id}} templatefocus_id: {{selected_story.templatefocus.id}} template_id: {{selected_story.templatefocus.story_template.id}} ({{selected_story.templatefocus.story_template.title}})
      -->
      <p class="card-text mt-3">{{ selected_story.summary|safe }}</p>
    </b>
    {% with focus_images=selected_story.templatefocus.focus_image_links.all %}
	          {% if focus_images %}
	        {% for link in focus_images %}
	          {% if link.image.image %}
	            <img
	              src="{{ link.image.image.url }}"
	              class="img-fluid rounded mt-3 story-focus-image"
	              alt="{{ selected_story.title|striptags }}"
	            >
	            {% if link.image.credit_line_html %}
	              <small class="d-block text-muted mt-1">
	                {{ link.image.credit_line_html }}
              </small>
            {% elif link.image.credit_line %}
              <small class="d-block text-muted mt-1">
                {{ link.image.credit_line }}
              </small>
            {% elif link.image.image_source %}
              <small class="d-block text-muted mt-1">
                <a
                  href="{{ link.image.image_source }}"
                  target="_blank"
                  rel="noopener noreferrer"
                >Image source</a>
              </small>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}
    <p class="card-text mt-3">{{ selected_story.content_html|safe }}</p>
  </div>

  {% if tables %}
  <div class="mb-3 p-3 bg-light rounded">
  {% for table in tables %}
  <hr>
  <h5>{{ table.display_title }}</h5>
  <table class="table table-striped" id="{{ table.table_id }}">
    <thead>
      <tr>
        {% for column in table.columns %}
        <th>{{ column }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in table.rows %}
      <tr>
        {% for col in table.columns %}
        <td>{{ row|get_item:col |safe}}</td>
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div class="d-flex justify-content-end mb-2">
    <a
      class="btn btn-sm btn-link text-decoration-none"
      href="{% url 'story_table_download' table.id %}"
      title="download data to csv file"
      aria-label="download data to csv file"
    >
      <i class="bi bi-download"></i>
    </a>
  </div>
  <br>
  {% endfor %}
  </div>
  {% endif %}

  {% if graphics %}
    {% for graphic in graphics %}
    <h5>Figure {{ graphic.graphic_template.sort_order|default:0|add:"1" }}: {{ graphic.title }}</h5>
    {{ graphic.content_html|safe }}
    <!-- 
    {% if graphic.chart_id %}
    <div class="d-flex justify-content-end mb-2">
      <a
        class="btn btn-sm btn-link text-decoration-none"
        href="#"
        data-chart-id="{{ graphic.chart_id }}"
        data-download-name="graphic-{{ graphic.id }}.png"
        title="Download plot as PNG"
        aria-label="Download plot as PNG"
      >
        <i class="bi bi-download"></i>
      </a>
    </div>
    {% endif %}
    -->
    <br>
    <!-- debug: graphic ids
cal    {{ graphic.id}} {{graphic.graphic_template.id}}
    -->
    {% endfor %}
    <script>
      (function () {
        function downloadChart(chartId, filename) {
          if (!chartId || !window.__vegaViews || !window.__vegaViews[chartId]) {
            return;
          }
          var view = window.__vegaViews[chartId];
          view
            .toImageURL("png")
            .then(function (url) {
              var link = document.createElement("a");
              link.href = url;
              link.download = filename || (chartId + ".png");
              document.body.appendChild(link);
              link.click();
              link.remove();
            })
            .catch(function (err) {
              console.warn("Unable to export chart", err);
            });
        }

        document.addEventListener("click", function (event) {
          var target = event.target.closest("[data-chart-id]");
          if (!target) {
            return;
          }
          event.preventDefault();
          downloadChart(
            target.getAttribute("data-chart-id"),
            target.getAttribute("data-download-name")
          );
        });
      })();
    </script>
  {% endif %}
  
  <div class="mb-3 p-3 bg-light rounded">
  {% if data_source %}
    Data source:
    {% for source in data_source %}
    <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">{{ source.text }}</a>{% if not forloop.last %},
    {% endif %}
    {% endfor %}
  {% endif %}

  {% if other_ressources %}
  <br>
    Additional resources:
    {% for source in other_ressources %}
    <a href="{{ source.url }}" target="_blank" rel="noopener noreferrer">{{ source.text }}</a>{% if not forloop.last %},
    {% endif %}
    {% endfor %}
  {% endif %}
  <br><br>
  <p style="font-size: 0.9em;">{{ AI_DISCLAIMER | safe }}</p>
  </div>
</div>
